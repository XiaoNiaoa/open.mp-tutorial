# [教程] 基准测试 (Benchmarking)

原教程来自：https://sampforum.blast.hk/showthread.php?tid=218491   **作者：Slice**  


每天我都会看到人们用各种错误的方法对代码进行基准测试，所以我觉得有必要制定一个标准，让大家能轻松对比不同的基准测试结果。

最近我更新了自己的基准测试宏，加入了“预热”机制以获得最高精度。下面我会详细说明。

## 为什么要进行基准测试？

主要是为了确保你的代码不会给服务器带来性能问题。

## 如何进行基准测试？

```pawn
// 复制下面两个宏到你的脚本里

// 开始测试
#define START_BENCH(%0); {new __a=%0,__b=0,__c,__d=GetTickCount(),__e=1;do{}\
    while(__d==GetTickCount());__c=GetTickCount();__d=__c;while(__c-__d<__a||\
    __e){if(__e){if(__c-__d>=__a){__e=0;__c=GetTickCount();do{}while(__c==\
    GetTickCount());__c=GetTickCount();__d=__c;__b=0;}}{

// 结束测试并显示结果
#define FINISH_BENCH(%0); }__b++;__c=GetTickCount();}printf(" Bench for "\
    %0": executes, by average, %.2f times/ms.",floatdiv(__b,__a));}

// 这样写测试代码
START_BENCH( 1000 );
{
    // ←←← 把你要测试的代码写在这里
    floatdiv( 5412.4121234, 2412.1111 );// 举例：测试这个除法函数
}
FINISH_BENCH( "floatdiv" );
```

### 注意！

- 请尽量把所有要测试的代码都放在基准测试函数内部；变量声明等也要放在两个宏之间。
- **仅用于测试** —— 它会让你的服务器冻结几秒钟（具体取决于你设置的测试时间）。
- 在测试期间不要做任何可能影响结果的事情（听音乐、看视频、在游戏中操作等）。你完全可以忍耐2秒钟不做这些事。

## 测试结果

结果会以以下格式显示：

```
Bench for x: executes, by average, x times/ms.
```

意思是：这段代码平均每毫秒可以执行多少次。这能让你对性能有一个非常直观的了解！

**性能参考标准**：
- 任何 **大于 1 次/毫秒** 的代码都是 **可接受** 的。不过当服务器上有大量玩家，或者这段代码被频繁调用时，仍然可能会让服务器负载加重。
- 如果你要制作供其他人使用的函数，建议保持在 **50 次/毫秒以上**。
- 对于在回调（callbacks）或其他大型代码块中使用的代码，建议保持在 **20 次/毫秒以上**。


### 人类可读版本（仅供参考）

以下是宏的完整展开形式（压缩版是为了方便复制）：

#### START_BENCH

```pawn
{ // 把所有基准测试代码放在一个代码块里，避免多次使用时出现“变量已存在”的错误
    new
             iMeasureTime = %0, // 要运行代码的毫秒数
             iCount = 0,        // 代码执行次数
             iTick = GetTickCount( ), // 当前 Tick
             iStartTick,        // 基准测试开始时的 Tick
        bool:bWarmup = true // 是否处于预热阶段
    ;

    do { } while ( iTick == GetTickCount( ) ); // 等待并在 Tick 计数器跳动后立即开始（提高精度）

    iTick = GetTickCount( );
    iStartTick = iTick;

    while ( iTick - iStartTick < iMeasureTime || bWarmup ) // 只要执行时间未超过设定值或仍在预热
    {
        if ( bWarmup ) // 如果处于预热阶段
        {
            if ( iTick - iStartTick >= iMeasureTime ) // 且预热时间已到
            {
                bWarmup = false; // 结束预热

                iTick = GetTickCount( );

                do { } while ( iTick == GetTickCount( ) ); // 等待下一个 Tick

                iTick = GetTickCount( );
                iStartTick = iTick;

                iCount = 0; // 预热结束后重置计数器
            }
        }
```

#### FINISH_BENCH

```pawn
        }
        
        iCount++; // 增加执行次数
        
        iTick = GetTickCount( ); // 更新当前 Tick
    }
    
    printf( " Bench for " %0 ": executes, by average, %.2f times/ms.", floatdiv( iCount, iMeasureTime ) ); // 输出结果
}
```

## 附加说明（来自原帖讨论）

- **正确测试循环的示例**（Slice 提供）：

```pawn
START_BENCH( 1000 );
{
    for (new j = 0; j < MAX_PLAYERS; j++) {
        if (pInfo[j][pConnected]) {}
    }
}
FINISH_BENCH( "My Test" );
```

- 预热（Warmup）机制能显著提高精度，避免首次执行时的缓存/初始化偏差。
- 基准测试应在**隔离环境**下进行，避免外部状态（如玩家、定时器）影响结果。

---
